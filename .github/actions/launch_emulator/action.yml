name: 'Create and launch emulator then run the input script'
description: 'Launches an Android emulator and runs the input script'
inputs:
  script:
    description: 'Script runs after successful launch of the emulator'

defaults:
  run:
    shell: bash

env:
  ANDROID_BUILD_TOOLS_VERSION: 30.0.2

runs:
  using: 'composite'
  steps:
      - name: Add `avdmanager` and `sdkmanager` to System PATH
        run: |
            echo "$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/emulator:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/${{ env.ANDROID_BUILD_TOOLS_VERSION }}" >> $GITHUB_PATH
        shell: bash

      - name: SDK package licenses agreement
        run: |
          # chmod +x ./.github/scripts/accept_license.exp
          # ./.github/scripts/accept_license.exp
          yes | sdkmanager --licenses
        shell: bash

      - name: Install System Image
        run: |
            sdkmanager --install 'system-images;android-30;google_apis_playstore;x86_64'
        shell: bash

      - name: Create Emulator
        id: create_emulator
        # Create an emulator using avdmanager and do not create custom hardware profile by prompting answer as "no"
        run: echo "no" | avdmanager create avd -n TestEmulator30 -k "system-images;android-30;google_apis_playstore;x86_64"
        shell: bash

      - name: Check Emulator Creation Status
        run: |
          if [ $? -eq 0 ]; then  # Verfies the exit status of the last executed command i.e. "create_emulator", if it is 0 then the emulator is created succesfully
            echo "Emulator creation successful"
          else
            echo "Emulator creation failed"
            exit 1
          fi
        shell: bash

      - name: Restart adb server
        run: |
          adb kill-server
          adb start-server
        shell: bash

      - name: Launch Emulator
        run: |
          echo "~~~~~~ Starting emulator and waiting for boot to complete.... ~~~~~~"
          $ANDROID_HOME/emulator/emulator -avd TestEmulator30 -no-skin -no-audio -no-window &
          adb wait-for-device  # Waits until emulator is connected and ready/responsive to accept commands
          echo "~~~~~~ Emulator has finished booting ~~~~~~"
        shell: bash

      - name: Build App
        run: |
          chmod +x gradlew
          ./gradlew installDebug
        shell: bash

      - name: Run script
        run: bash -c "${{ inputs.script }}"
        shell: bash
