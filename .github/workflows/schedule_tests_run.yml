name: Schedule execution of all unit and instrumented tests
on:
  push:
    branches:
      VaibhavSMisal-patch-2
  pull_request:
    branches:
      VaibhavSMisal-patch-2
  # schedule:
  #   - cron: '15 14 * * *'
  workflow_dispatch:

jobs:
  nightly_end_to_end_tests:
    name: Launch emulator, run all unit and instrumented tests and send results on Slack 
    runs-on: macos-latest

    steps:
      - name: Checkout the code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: run unit tests and save the output
        id: unitTests
        run: |
          chmod +x gradlew
          ./gradlew test > unit_tests_output.txt

      - name: print output
        if: always()
        run: cat unit_tests_output.txt

      - name: Create and Launch emulator
        uses: ./.github/actions/launch_emulator
        with:
          script: |
            echo "NO Script"

      - name: Run instrumented tests and save the output
        id: instrumentedTests
        run: ./gradlew connectedCheck > instrumented_tests_output.txt

      - name: print output
        if: always()
        run: cat instrumented_tests_output.txt

      - name: print date
        if: always()
        run: |
          today=$(date +'%Y-%m-%dT%H:%M:%S')
          echo "today: $today"

      # - name: send message
      #   if: always()
      #   run: |
      #     if [ ${{ steps.test.outcome }} == 'success' ]; then
      #       curl -X POST -H 'Content-type: application/json' --data '{"message" : "All tests passed!"}' $SLACK_WEBHOOK_URL
      #     else
      #       tests=$(cat test_output.txt | grep -E "com.example.breach.*FAILED")
      #       curl -X POST -H 'Content-type: application/json' --data '{"message" : "Following tests failed!\n $tests"}' $SLACK_WEBHOOK_URL
      #     fi
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # - name: send message
      #   if: always()
      #   run: |
      #     if [ ${{ steps.ranTest.outcome }} == 'success' ]; then
      #       echo "All tests passed!"
      #     else
      #       tests=$(cat test_output.txt | grep -E "com.example.breach.*FAILED")
      #       echo "Following tests failed!\n $tests"
      #     fi
